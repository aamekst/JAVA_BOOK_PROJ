<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Cadastrar Avaliação</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function buscarLivro() {
            const nome = $('#nome').val();
            if (nome.length > 2) { // Iniciar busca com 3 caracteres ou mais
                $.ajax({
                    url: '/api/buscarLivros', // Caminho para o endpoint correto
                    type: 'GET',
                    data: { nome: nome },
                    success: function (livros) {
                        console.log('Livros encontrados:', livros); // Verifique o retorno
                        if (livros.length > 0) {
                            const livro = livros[0];
                            $('#autor').val(livro.autor ? livro.autor.nome : ''); // Atualizar com dados do autor
                            $('#editora').val(livro.editora ? livro.editora.nome : ''); // Atualizar com dados da editora
                            $('#data_publicacao').val(formatarData(livro.data_publicacao) || ''); // Atualizar com data de publicação
                            $('#numero_paginas').val(livro.numero_paginas || ''); // Atualizar com número de páginas

                            // Atualizar com URL da foto
                            const imagemUrl = livro.url_foto ? livro.url_foto : '';
                            console.log('URL da imagem:', imagemUrl); // Verifique o valor da URL
                            $('#livroImagem').attr('src', imagemUrl); // Atualizar com URL da foto
                        } else {
                            // Limpar os campos se nenhum livro for encontrado
                            $('#autor').val('');
                            $('#editora').val('');
                            $('#data_publicacao').val('');
                            $('#numero_paginas').val('');
                            $('#livroImagem').attr('src', ''); // Limpar a imagem
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error('Erro ao buscar informações do livro:', textStatus, errorThrown);
                        alert('Livro não encontrado, cadastre.');
                    }
                });
            }
        }

        function formatarData(data) {
            // Assumindo que data está no formato ddMMyyyy
            if (data && data.length === 8) {
                const dia = data.substring(0, 2);
                const mes = data.substring(2, 4);
                const ano = data.substring(4, 8);
                return `${dia}/${mes}/${ano}`; // Exemplo de formato: 18/04/2023
            }
            return data;
        }

        function atualizarDetalhes() {
            const nota = $('#nota').val();
            const comentario = $('#comentario').val();

            $('#notaExibida').text(`Nota: ${nota}`);
            $('#comentarioExibido').text(` ${comentario}`);
        }
    </script>
</head>
<body>
<div class="container">
    <!-- Formulário de Cadastro -->
    <div class="form-container">
        <h2>Cadastro de Avaliações</h2>
        <form id="formLivro">
            <div class="form-group">
                <label for="nome">Nome do Livro:</label>
                <input type="text" id="nome" name="nome" autocomplete="off" oninput="buscarLivro()">
            </div>
            <div class="form-group">
                <label for="autor">Autor:</label>
                <input type="text" id="autor" name="autor" readonly>
            </div>
            <div class="form-group">
                <label for="editora">Editora:</label>
                <input type="text" id="editora" name="editora" readonly>
            </div>
            <div class="form-group">
                <label for="data_publicacao">Data de Publicação:</label>
                <input type="text" id="data_publicacao" name="data_publicacao" readonly>
            </div>
            <div class="form-group">
                <label for="numero_paginas">Número de Páginas:</label>
                <input type="text" id="numero_paginas" name="numero_paginas" readonly>
            </div>
            <div class="form-group">
                <label for="nota">Nota:</label>
                <input type="number" id="nota" name="nota" min="0" max="10">
            </div>
            <div class="form-group">
                <label for="comentario">Comentário:</label>
                <textarea id="comentario" name="comentario"></textarea>
            </div>
            <button type="button" onclick="atualizarDetalhes()">Salvar</button>
            <button type="reset" onclick="atualizarDetalhes()">Limpar</button>
        </form>
    </div>

    <!-- Card do Livro -->
    <div class="card">
        <div class="imgBox">
            <img id="livroImagem" src="/image/Literature-pana.jpg" alt="Imagem do Livro">
        </div>
        <div class="details">
            <h2>ANOTAÇÕES</h2>
            <p id="notaExibida">Nota: </p>
            <p id="comentarioExibido"> </p>
        </div>
    </div>
    <div class="card-buttons">
        <a href="/api/livros/cadastrar" class="button-link">Cadastrar livro</a>
    </div>
</div>
</body>
</html>
